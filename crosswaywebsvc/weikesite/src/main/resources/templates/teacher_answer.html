<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>教师批改作业</title>
<meta charset="utf-8" />
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<link href="/css/skin.css" rel="stylesheet">
<link href="/css/share.css" rel="stylesheet">
<style type="text/css">
	.open_btn{
		width: auto; margin-top:10px; min-width:170px;
		color: #ffffff;
		font-size: 16px;  
	    background-color:#84c825; line-height:40px; border:0px; border-radius:3px; margin-bottom:10px; padding:0px 20px;
	}                
                
	.view_btn{
		width: auto; margin-top:10px; min-width:170px;
		color: #fff;
		font-size: 16px;  
	    background-color:#f1b500; line-height:40px; border:0px; border-radius:3px; margin-bottom:10px; padding:0px 20px;
	}       
}
</style>
<script src="/js/jquery.min.js"></script>
<script src="/js/jcanvas.min.js"></script>
<script type="text/javascript">
	$(function(){
			$("#edit").hide();
			$("#picAnswer").hide();
			$("#divcanvas").hide();
			$(".showVideo").hide();
			$("#videoShow").click(function(){
				$("#video").toggle();
				$("#no_video").toggle();
				if($(this).text() == "查看视频") {
					$(this).text("隐藏视频");
				} else {
					$(this).text("查看视频");
				}
			});
			$("#picShow").click(function(){
				$("#picAnswer").toggle();
				$("#divcanvas").toggle();
				$("#edit").toggle();
				if($(this).text() == "打开曲谱图编辑框") {
					$(this).text("关闭曲谱图编辑框");
				} else {
					$(this).text("打开曲谱图编辑框");
				}
			});
	})
</script>
<script>
var isEdit = false;
function setIsEdit(is) {
	isEdit = is;
	if (isEdit) {
		document.getElementById("imgEdit").src = "/images/pen_select.png";
		document.getElementById("imgNotEdit").src = "/images/move.png";
	}
	else {
		document.getElementById("imgEdit").src = "/images/pen.png";
		document.getElementById("imgNotEdit").src = "/images/move_select.png";
	}
}

var scale = 1;
function scaleCanvas(s) {
	scale *= s;
	var canvas = document.getElementById("mycanvas");
	var img = document.getElementById("tulip");
	var div = document.getElementById("divcanvas");
	canvas.style.MozTransform = 'scale(' + scale + ')';
	canvas.style.WebkitTransform = 'scale(' + scale + ')';
	canvas.style.OTransform = 'scale(' + scale + ')';
	canvas.style.marginTop = (scale - 1) * 0.5 * img.height + 'px';
	canvas.style.marginLeft = (scale - 1) * 0.5 * img.width + 'px';
	div.style.height = (img.height * scale) + 'px';
}

$(function () {
	var c = document.getElementById("mycanvas");
	var ctx = c.getContext("2d");
	ctx.lineCap = "round";　　//设置线条两端为圆弧
	ctx.lineJoin = "round";　　//设置线条转折为圆弧
	var img = document.getElementById("tulip");
	c.width = img.width;
	c.height = img.height;
	ctx.drawImage(img, 10, 10);
	$("#totulip").hide();
	$("#panrange").val(4);
	$("#panrangeval").val(4);
});

function changerange() {
	$("#panrangeval").val($("#panrange").val());
};

var maxX = -1;
var maxY = -1;
var minX = 99999;
var minY = 99999;

function checkData(event) {
	var x = event.pageX - $('canvas').offset().left;
	var y = event.pageY - $('canvas').offset().top;
	if (x > maxX) {
		maxX = x;
	} else if (x < minX) {
		minX = x;
	}
	if (y > maxY) {
		maxY = y;
	} else if (y < minY) {
		minY = y;
	}
}

$(function () {
	var obj = $('canvas');
	var temp_e;
	var temp_draw = false;
	var panval = $("#panrange").val();
	var x = 0;
	var y = 0;

	obj.on({
		mousedown: function (e) {
			if (!isEdit){
				return;
			}	
			temp_e = e;
			temp_draw = true;
			checkData(e);
		},
		touchstart: function (e) {
			if (!isEdit){
				return;
			}	
			temp_e = e.originalEvent.targetTouches[0];
			x = e.originalEvent.touches[0].pageX;
			y = e.originalEvent.touches[0].pageY;
			temp_draw = true;
			checkData(temp_e);
		},
		mousemove: function (e) {
			if (!isEdit){
				return;
			}	
			if (temp_draw) {
				obj.drawLine({
					strokeStyle: $("input[name='rcolor']:checked").val(),
					strokeWidth: $("#panrange").val(),
					x1: (temp_e.pageX - $('canvas').offset().left) / scale,
					y1: (temp_e.pageY - $('canvas').offset().top) / scale,
					x2: (e.pageX - $('canvas').offset().left) / scale,
					y2: (e.pageY - $('canvas').offset().top) / scale,
				});
			}
			temp_e = e;
			checkData(e);
		},
		touchmove: function (e) {
			if (!isEdit){
				return;
			}	
			
			
			e.preventDefault();
			//此处使用temp_e在iphone，ipad上Safari会造成new_e和temp_e坐标相同。
			//document.getElementById('inp').innerHTML = "<br>(" + e.originalEvent.touches[0].pageX + "," + event.touches[0].pageY + ")";
			//document.getElementById('inp').innerHTML += "<br>(" + x + "," + y + ")";
			var new_e = e.originalEvent.touches[0];
			if (temp_draw) {
				obj.drawLine({
					strokeStyle: $("input[name='rcolor']:checked").val(),
					strokeWidth: $("#panrange").val(),
					x1: (x - $('canvas').offset().left) / scale,
					y1: (y - $('canvas').offset().top) / scale,
					x2: (new_e.pageX - $('canvas').offset().left) / scale,
					y2: (new_e.pageY - $('canvas').offset().top) / scale,
				});
			}
			temp_e = new_e;
			x = e.originalEvent.touches[0].pageX;
			y = e.originalEvent.touches[0].pageY;
			checkData(temp_e);
		},
		mouseup: function (e) {
			if (!isEdit){
				return;
			}	
			temp_e = null;
			temp_draw = false;
			checkData(e);
		},
		touchend: function (e) {
			if (!isEdit){
				return;
			}	
			temp_e = null;
			temp_draw = false;
			checkData(e.originalEvent);
		},
		mouseout: function () {
			if (!isEdit){
				return;
			}	
			temp_e = null;
			temp_draw = false;
		}
	});

	$("#clearup").on("click", function () {

		maxX = -1;
		maxY = -1;
		minX = 99999;
		minY = 99999;
		obj.clearCanvas();

		var c = document.getElementById("mycanvas");
		var ctx = c.getContext("2d");
		var img = document.getElementById("tulip");
		c.width = img.width;
		c.height = img.height;
		ctx.drawImage(img, 10, 10);
		$("#totulip").hide();

	});
    $("#save").on("click", function () {
    	var teachercomment = $("#teachercomment").val()
    	if(teachercomment.trim()==""){
    		alert("请输入评语");
    		return;
    	}
        var image2 = obj.getCanvasImage("png");
        $("#GradeIMGBase64").val(image2);
        console.log(image2);
        $("#form1").submit();
    });

});
</script>
<link href="/css/drawingboard.css" rel="stylesheet">
</head>
<body>
	<div th:include="common/head1"></div>
	<div class="contain_wrap">
		<div class="contain_sub">
			<div class="logo">
				<img src="/images/logo.png" class="lgpic">
			</div>
			<span class="title"><span style="margin-right: 3px;"
				th:text="${homework.studentnickname}">（李东）</span> 上传了 <span
				style="margin-left: 5px;" th:text="${homework.title}">老麦克唐纳</span></span> <span
				class="author" th:text="'曲谱:'+${homework.mdiportfolio}">曲谱：约翰&#8226;汤普森简易钢琴教程1</span>
			<span class="author"
				th:text="'上传时间：'+${#calendars.format(homework.studenttime,'yyyy/MM/dd HH:mm:ss')}"
				th:if="${status==0}">上传时间：2016/7/4 17:06:28</span> <span
				class="author"
				th:text="'提交时间：'+${#calendars.format(homework.addtime,'yyyy/MM/dd HH:mm:ss')}"
				th:if="${status==1}">提交时间：2016/7/4 17:06:28</span>
		</div>
		<div class="contain_pic">
			<audio id="myaudio" style="width: 75%"
				th:src="'http://piano-static.klsw.com'+${homework.mp3path}"
				controls="controls">
			</audio>
		</div>
		<div style=" margin:0 auto; text-align:center;"><button class="view_btn" type="submit" style="outline:none;" id="videoShow">查看视频</button></div>
		<video id="video" class="showVideo" th:src="'http://wk-static.klsw.com'+${homework.img}" controls="controls" style="width: 100%;height: auto;" th:if="${homework.img} != null">您的浏览器不支持该标签</video>
		<span id="no_video" style="padding:0 0 0 80px;" class="showVideo" th:if="${homework.img} == null">温馨提示：该学生尚未上传视频</span>
		<div style=" margin:0 auto; text-align:center;" th:if="${homework.teachertime} == null"><button id="picShow" class="open_btn" type="submit" style="outline:none;">打开曲谱图编辑框</button></div>
		<div id="picAnswer" th:if="${homework.teachertime} == null">
			<div class="top"
				style="padding: 0px 3%; margin-top: 30px; text-align: center">
				<div id="color">
					画笔颜色： <input type="radio" name="rcolor" value="#FF0000"
						checked="checked" /> <input class="i1" type="button"
						style="background-color: #ff0000" /> &nbsp;&nbsp; <input
						type="radio" name="rcolor" value="#00FF00" /> <input class="i2"
						type="button" style="background-color: #00ff00" /> &nbsp;&nbsp; <input
						type="radio" name="rcolor" value="#0000FF" /> <input class="i3"
						type="button" style="background-color: #0000ff" />
				</div>
			</div>
			<div class="font" id="font"
				style="padding: 0px 3%; text-align: center">
				画笔粗细： <input type="text" id="panrangeval" value=""
					readonly="readonly"
					style="width: 20px; background-color: transparent;" /> <input
					type="range" id="panrange" value="4" min="1" max="8"
					style="width: 150px; height: 30px;" onChange="changerange()" />
			</div>
			<div style="text-align: center;">
				<button id="clearup" style="background-color: transparent; color: #0094ff; margin-bottom: 20px; font-size: 16px;">清除画布</button>
			</div>
			<div
				style="text-align: center; background-color: transparent; color: #888; margin-left: 3%; margin-bottom: 20px; font-size: 16px;">&nbsp;-&nbsp;如果曲谱未显示请点击清除画布重试</div>
		</div>
		<div
			style="border: 2px dashed #aaa; width: 94%; overflow: auto; margin: 0 auto;"
			id="divcanvas">
			<canvas id="mycanvas"></canvas>
		</div>
		<div>
			<img th:src="${homework.midimgpath}" alt="" id="tulip"
				hidden="hidden" th:if="${homework.teachertime} == null" />
			<img th:src="'http://wk-static.klsw.com'+${homework.gradeimgpath}" alt=""
				id="tulip" hidden="hidden" th:if="${homework.teachertime} != null" />
		</div>
	</div>
	<div id="edit"
		style="z-index=99;position: fixed; right: 15px; top: 40%; width: 70px; text-align: center;">
		<div>
			<a onclick="scaleCanvas(1.25);"><img src="/images/scale_up.png"
				style="height: 50px; width: 50px;" alt="" /></a>
		</div>
		<div>
			<a onclick="scaleCanvas(0.8);"><img src="/images/scale_down.png"
				style="height: 50px; width: 50px;" alt="" /></a>
		</div>
		<div th:if="${homework.teachertime} == null">
			<div>
				<a onclick="setIsEdit(false)"><img id="imgNotEdit"
					src="/images/move_select.png" style="height: 50px; width: 50px;"
					alt="" />
				</a>
			</div>
			<div>
				<a onclick="setIsEdit(true)"><img id="imgEdit"
					src="/images/pen.png" style="height: 50px; width: 50px;" alt="" />
				</a>
			</div>
		</div>
	</div>
	<div style="margin: 0 auto; text-align: center;"
		th:if="${homework.teachertime} == null">
		<form action="/homework/answer" id="form1" method="post">
			<textarea id="teachercomment" name="teachercomment" cols="" rows=""
				class="area" placeholder="请输入对学生作业的批改回复" required="required"></textarea>
			<input name="homeworkid" type="hidden" th:value="${homework.id}" />
			<input name="image" type="hidden" id="GradeIMGBase64" />
		</form>
		<button id="save" class="submitBtn" style="outline: none;">提交回复</button>
	</div>
	<div class="answer_info" th:text="${homework.teachercomment}"
		th:if="${homework.teachertime} != null">张老师批改回复：节奏感不错，非常好，除了二连音有点问题不准确，其他都非常好，请继续保持，多加练习。再弹一首别的曲目发给我。注意跟着感觉走，需要有感情地投入。</div>
</body>
</html>
